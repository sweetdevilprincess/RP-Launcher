# Agent Cache Format - Current Implementation

**File**: `state/agent_analysis.md`
**Last Updated**: 2025-10-14

This document shows the CURRENT formatting implementation for the agent cache file.

---

## 📁 Current Implementation Structure

### Three-Layer Format System:

```
┌─────────────────────────────────────────┐
│ 1. save_to_cache() - File Wrapper      │  ← AgentCoordinator
│   ├── File header                       │
│   ├── Cache metadata                    │
│   ├── Agent sections                    │  ← _format_context()
│   └── Performance summary               │
└─────────────────────────────────────────┘
           │
           ├── 2. _format_context() - Agent Container
           │    ├── Header comments
           │    ├── Individual agent outputs  ← Agent.format_output()
           │    ├── Failure notes
           │    └── Footer comments
           │
           └── 3. Agent.format_output() - Individual Sections
                ├── Agent header (### emoji Agent Name)
                ├── Metadata (response #, timestamp, status)
                ├── DeepSeek raw result
                └── Separator (---)
```

---

## 📄 Current Output Example

Here's what's currently being saved to `agent_analysis.md`:

```markdown
# Agent Analysis Cache
<!-- Auto-generated by RP Claude Code Agent System -->

## 🔍 Cache Metadata

**Current Response Number**: 120
**Last Analysis**: 2025-10-14 16:45:30
**Cache Status**: ✅ Fresh
**Total Agents Run**: 10/10 successful

---

<!-- ========== AGENT CONTEXT SYNTHESIS ========== -->
<!-- Generated: 2025-10-14 16:45:30 -->
<!-- Agents: 10 successful, 0 failed -->

### Agent: Scene classification, character identification, pacing analysis
<!-- Agent ID: response_analyzer | Duration: 15234ms -->

### 1️⃣ Response Analyzer
<!-- Agent ID: response_analyzer | Phase: 0.4 (Background Analysis) -->

**Response Number**: 120
**Timestamp**: 2025-10-14 16:43:15
**Status**: ✅ Success

Scene Type: dialogue
Pacing: medium
Tension Level: 6/10
Word Count: 450

Characters in Scene:
- Marcus Thompson (protagonist)
- Lily Chen (love interest)

Characters Mentioned (Not Present):
- David Park (mentioned by name)
- Sarah Mitchell (mentioned in context)

Location: Coffee Corner Cafe
Location Changed: No

Time Passed: 30 minutes
Current Timestamp: Tuesday, 3:00 PM

Variety Alert: Last 4 of 5 responses are dialogue-heavy. Consider action or world-building scene.
Pacing Note: Tension has been steady at 6/10 for last 3 responses.

---

### Agent: Extract memorable moments from response
<!-- Agent ID: memory_creation | Duration: 5123ms -->

### 2️⃣ Memory Creation
<!-- Agent ID: memory_creation | Phase: 1.1 (Memory Extraction) -->

**Response Number**: 120
**Chapter**: 5
**Timestamp**: 2025-10-14 16:43:45
**Status**: ✅ Success

Memories Extracted: 2

Memory #1: Marcus Vulnerability Moment
- Characters Present: Marcus, Lily
- Location: Coffee Corner Cafe
- Type: revelation
- Significance: 8/10
- Emotional Tone: vulnerable, hopeful
- Summary: Marcus revealed his fear of commitment stemming from his parents' divorce
- Quote: "I've never told anyone this before, but..."
- Tags: #vulnerability #backstory #marcus #lily
- Recommended File: memories/marcus/MEM-120-vulnerability.md

Memory #2: Lily Empathy Response
- Characters Present: Lily
- Location: Coffee Corner Cafe
- Type: character_moment
- Significance: 6/10
- Emotional Tone: empathetic
- Summary: Lily showed deep understanding of Marcus's fears
- Quote: "It's okay to be scared. That just means it matters."
- Tags: #empathy #lily #relationship_development
- Recommended File: memories/lily/MEM-120-empathy.md

---

### Agent: Preference matching and tier tracking
<!-- Agent ID: relationship_analysis | Duration: 4892ms -->

### 3️⃣ Relationship Analysis
<!-- Agent ID: relationship_analysis | Phase: 1.2 (Dynamic Relationships) -->

**Response Number**: 120
**Timestamp**: 2025-10-14 16:44:20
**Status**: ✅ Success

Interactions Analyzed: 1

Marcus ↔ Lily:
- Current Tier: Acquaintance (Score: 28/100)
- Previous Score: 18/100
- Change: +10 points
- Trigger: Lily showed empathy (Marcus preference: emotional_intelligence +10)

Preference Matches:
- ✅ Lily showed empathy → Marcus likes emotional_intelligence (+10)

Tier Change: No (still Acquaintance tier: 11-30)
- Next Tier: Friend (31-60) requires +3 more points
- Trajectory: Positive, relationship progressing naturally

Notes: Marcus opening up is significant. Tier change likely within 2-3 interactions if positive momentum continues.

---

### Agent: Identify new/mentioned/resolved plot threads
<!-- Agent ID: plot_thread_detection | Duration: 5234ms -->

### 4️⃣ Plot Thread Detection
<!-- Agent ID: plot_thread_detection | Phase: 2.1 (Plot Threads) -->

**Response Number**: 120
**Timestamp**: 2025-10-14 16:44:50
**Status**: ✅ Success

New Plot Threads Introduced: 1

THREAD-025: Marcus's Commitment Issues
- Status: Active
- Priority: Medium
- Time Sensitive: No
- Related Characters: Marcus, Lily (potential)
- Tags: #character_development #romance #backstory
- Recommendation: Add to plot_threads_master.md

Threads Mentioned: 2

THREAD-001: Marcus Job Interview at Morrison Law Firm
- Last Mentioned: Response 120 (now)
- Responses Since Last Mention: 0
- Consequence Status: ⚠️ WARNING - 5 responses until firm hires someone else
- Update: Marcus mentioned "still waiting to hear back"

THREAD-018: Lily's Photography Exhibition
- Last Mentioned: Response 120 (now)
- Responses Since Last Mention: 0
- Consequence Status: ✅ On track - Exhibition in 15 responses
- Update: Lily mentioned "getting ready for the show"

Threads Resolved: 0

---

### Agent: Extract world-building facts
<!-- Agent ID: knowledge_extraction | Duration: 3421ms -->

### 5️⃣ Knowledge Base Extraction
<!-- Agent ID: knowledge_extraction | Phase: 2.2 (Knowledge Base) -->

**Response Number**: 120
**Timestamp**: 2025-10-14 16:45:15
**Status**: ✅ Success

Facts Extracted: 3

Fact #1: Location Detail
- Category: Locations
- Subject: Coffee Corner Cafe
- Fact: Espresso machine has been broken for 2 weeks
- Source: Chapter 5, Response 120
- Confidence: High

Fact #2: Character Background
- Category: Characters
- Subject: Marcus Thompson
- Fact: Parents divorced when he was 12 years old, causing deep-seated trust issues
- Source: Chapter 5, Response 120
- Confidence: High (direct character revelation)

Fact #3: Cultural Detail
- Category: Setting
- Subject: Local Art Scene
- Fact: Photography exhibitions are held at Downtown Gallery on a monthly basis
- Source: Chapter 5, Response 120
- Confidence: Medium (casual mention)

Recommendation: Add all facts to state/knowledge_base.md

---

### Agent: Optional fact-checking
<!-- Agent ID: contradiction_detection | Duration: 0ms -->

### 6️⃣ Contradiction Detection
<!-- Agent ID: contradiction_detection | Phase: 2.3 (Contradiction Detection) -->

**Response Number**: 120
**Timestamp**: 2025-10-14 16:45:30
**Status**: ⏭️ Skipped (Feature not enabled)

Note: This agent is optional and currently disabled to save cost. Enable in automation_config.json if needed.

---

### Agent: Three-tier entity loading
<!-- Agent ID: quick_entity_analysis | Duration: 3124ms -->

### 7️⃣ Quick Entity Analysis
<!-- Agent ID: quick_entity_analysis | Phase: 0.5 (Context Intelligence) -->

**User Message**: N+1
**Timestamp**: 2025-10-14 16:45:45
**Status**: ✅ Success

Entities Detected in User Message:

Tier 1 - Scene Participants (Load Full Cards):
- Marcus Thompson (entities/Marcus.md - 3,200 tokens)
- Lily Chen (entities/Lily.md - 2,800 tokens)

Tier 2 - Mentioned But Absent (Extract Facts Only):
- David Park (entities/David.md - 2,200 tokens)
- Sarah Mitchell (entities/Sarah.md - 1,800 tokens)

Tier 3 - Not Mentioned (Skip):
- Amy Rodriguez (not relevant to current scene)
- [12 other entities not mentioned]

Locations Mentioned:
- Coffee Corner Cafe (current location, locations/Coffee_Corner_Cafe.md)
- Morrison Law Firm (mentioned in context, locations/Morrison_Law_Firm.md)

**Action**: Load Tier 1 full cards, extract Tier 2 facts, skip Tier 3 entities

---

### Agent: Extract facts for Tier 2 entities
<!-- Agent ID: fact_extraction | Duration: 2341ms -->

### 8️⃣ Fact Extraction (Tier 2 Entities)
<!-- Agent ID: fact_extraction | Phase: 0.5 (Context Intelligence) -->

**User Message**: N+1
**Timestamp**: 2025-10-14 16:46:00
**Status**: ✅ Success

David Park (Tier 2 - Mentioned But Absent):
Card: entities/David.md (2,200 tokens)

Key Facts Extracted:
1. Marcus's best friend since college
2. Works as software engineer at TechCorp
3. Known for being blunt and direct in his opinions
4. Doesn't approve of Lily (thinks she's "too flighty")
5. Recently got engaged to Amy Rodriguez

Token Reduction: 2,200 → 58 tokens (97% reduction)

---

Sarah Mitchell (Tier 2 - Mentioned But Absent):
Card: entities/Sarah.md (1,800 tokens)

Key Facts Extracted:
1. Marcus's younger sister
2. Graduate student studying psychology at State University
3. Very close relationship with Marcus, often worries about him
4. Met Lily once at a party, thought she was sweet
5. Currently stressed about thesis deadline

Token Reduction: 1,800 → 52 tokens (97% reduction)

---

Total Tier 2 Token Reduction: 4,000 → 110 tokens (97% reduction)
Tokens Saved: 3,890 tokens

---

### Agent: Select relevant memories per character
<!-- Agent ID: memory_extraction | Duration: 2892ms -->

### 9️⃣ Memory Extraction
<!-- Agent ID: memory_extraction | Phase: 1.1 (Memory Extraction) -->

**User Message**: N+1
**Timestamp**: 2025-10-14 16:46:15
**Status**: ✅ Success

Marcus Thompson - Relevant Memories (3 from 45 total):

MEM-120: Vulnerability Moment
- When: Chapter 5, Response 120 (just now)
- Location: Coffee Corner Cafe
- Significance: 8/10
- Why Relevant: Just occurred, colors current emotional state
- Summary: Revealed fear of commitment from parents' divorce

MEM-087: First Coffee Date with Lily
- When: Chapter 4, Response 87
- Location: Coffee Corner Cafe
- Significance: 7/10
- Why Relevant: Foundation of their developing connection
- Summary: First real conversation, discovered shared interest in photography

MEM-012: Parents' Divorce Memory (Backstory)
- When: Chapter 1, Response 12
- Location: Childhood home flashback
- Significance: 9/10
- Why Relevant: Root cause of commitment issues just revealed
- Summary: Witnessed parents' bitter divorce at age 12, felt powerless

Token Reduction: 8,500 → 315 tokens (96% reduction)

---

Lily Chen - Relevant Memories (2 from 28 total):

MEM-087: First Coffee Date with Marcus
- When: Chapter 4, Response 87
- Location: Coffee Corner Cafe
- Significance: 7/10
- Why Relevant: Shared memory with Marcus, mutual connection
- Summary: Felt comfortable opening up to Marcus, enjoyed conversation

MEM-105: Past Relationship Trauma (Backstory)
- When: Chapter 5, Response 105
- Location: Referenced in conversation
- Significance: 8/10
- Why Relevant: Makes her empathy for Marcus more meaningful
- Summary: Ex-boyfriend was emotionally unavailable, caused deep hurt

Token Reduction: 6,200 → 275 tokens (96% reduction)

---

Total Memory Token Reduction: 14,700 → 590 tokens (96% reduction)
Tokens Saved: 14,110 tokens

---

### Agent: Select relevant plot threads
<!-- Agent ID: plot_thread_extraction | Duration: 3012ms -->

### 🔟 Plot Thread Extraction
<!-- Agent ID: plot_thread_extraction | Phase: 2.1 (Plot Threads) -->

**User Message**: N+1
**Timestamp**: 2025-10-14 16:46:30
**Status**: ✅ Success

Threads Loaded: 3 (from 25 active threads in master file)

THREAD-001: Marcus Job Interview at Morrison Law Firm ⚠️ CRITICAL
- Status: Active (CONSEQUENCE IMMINENT)
- Priority: High
- Last Mentioned: Response 120 (just mentioned)
- Consequence Countdown: 5 responses until firm hires someone else
- Why Loaded: Critical urgency, mentioned in current conversation
- Recommendation: Must address within next 5 responses or consequence triggers

THREAD-018: Lily's Photography Exhibition
- Status: Active
- Priority: Medium
- Last Mentioned: Response 120 (just mentioned)
- Time Sensitive: Yes (15 responses until exhibition date)
- Why Loaded: Recently mentioned, relevant to Lily's character development
- Recommendation: Natural story progression, no immediate action needed

THREAD-025: Marcus's Commitment Issues (NEW)
- Status: Active
- Priority: Medium
- Introduced: Response 120 (just now)
- Time Sensitive: No
- Why Loaded: Just introduced, shapes current scene dynamics
- Recommendation: Let this develop naturally through character interactions

---

Threads Monitored (Not Loaded): 22
- THREAD-003: David's Engagement Plans (low priority, not relevant)
- THREAD-007: Sarah's Thesis Defense (medium priority, not current)
- THREAD-012: Coffee Shop Ownership Drama (low priority, background)
- [+19 more threads tracked but not loaded]

Token Reduction: 5,500 → 785 tokens (86% reduction)
Tokens Saved: 4,715 tokens

---

<!-- ========== END AGENT CONTEXT ========== -->

## 📈 Performance Summary

**Total Duration**: 35124ms (35 seconds)
**Average Duration**: 3512ms
**Agents Run**: 10/10 successful
**Failures**: 0
**Balance Errors**: 0

```

---

## 🔧 Current Code Implementation

### 1. AgentCoordinator.save_to_cache()

**Location**: `src/automation/agent_coordinator.py:314-369`

```python
def save_to_cache(self, cache_file: Path, response_number: int) -> None:
    """Save agent results to cache file"""
    sections = []

    # Header
    sections.append("# Agent Analysis Cache")
    sections.append("<!-- Auto-generated by RP Claude Code Agent System -->")
    sections.append("")
    sections.append("## 🔍 Cache Metadata")
    sections.append("")
    sections.append(f"**Current Response Number**: {response_number}")
    sections.append(f"**Last Analysis**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    sections.append(f"**Cache Status**: ✅ Fresh")

    stats = self.get_stats()
    sections.append(f"**Total Agents Run**: {stats['successful']}/{stats['agents_executed']} successful")
    sections.append("")
    sections.append("---")
    sections.append("")

    # Get formatted context from _format_context()
    successful = [r for r in self.results.values() if r.success]
    failed = [r for r in self.results.values() if not r.success]
    context = self._format_context(successful, failed)
    sections.append(context)

    # Performance summary
    sections.append("")
    sections.append("## 📈 Performance Summary")
    sections.append("")
    sections.append(f"**Total Duration**: {stats['max_duration_ms']}ms")
    sections.append(f"**Average Duration**: {stats['avg_duration_ms']}ms")
    sections.append(f"**Agents Run**: {stats['successful']}/{stats['agents_executed']} successful")
    if stats['failed'] > 0:
        sections.append(f"**Failures**: {stats['failed']}")

    # Write to file
    cache_content = "\n".join(sections)
    cache_file.write_text(cache_content, encoding='utf-8')
```

### 2. AgentCoordinator._format_context()

**Location**: `src/automation/agent_coordinator.py:229-272`

```python
def _format_context(self, successful: List[AgentResult],
                   failed: List[AgentResult]) -> str:
    """Format agent results into context for Claude"""
    sections = []

    # Header
    sections.append("<!-- ========== AGENT CONTEXT SYNTHESIS ========== -->")
    sections.append(f"<!-- Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')} -->")
    sections.append(f"<!-- Agents: {len(successful)} successful, {len(failed)} failed -->")
    sections.append("")

    # Successful agent outputs
    for result in successful:
        agent_desc = next(
            (a.description for a in self.agents if a.agent_id == result.agent_id),
            result.agent_id
        )

        sections.append(f"### Agent: {agent_desc}")
        sections.append(f"<!-- Agent ID: {result.agent_id} | Duration: {result.duration_ms}ms -->")
        sections.append("")
        sections.append(result.content)  # ← Agent's format_output() result
        sections.append("")

    # Note failures
    if failed:
        sections.append("<!-- AGENT FAILURES -->")
        for result in failed:
            error_type = "LOW BALANCE" if result.is_balance_error else "ERROR"
            sections.append(f"<!-- {error_type}: {result.agent_id} - {result.error} -->")
        sections.append("")

    sections.append("<!-- ========== END AGENT CONTEXT ========== -->")

    return "\n".join(sections)
```

### 3. Individual Agent.format_output()

**Example**: `src/automation/agents/background/response_analyzer.py:116-136`

```python
def format_output(self, result: str, data: dict) -> str:
    """Format analysis result for cache"""
    output = f"""### 1️⃣ Response Analyzer
<!-- Agent ID: response_analyzer | Phase: 0.4 (Background Analysis) -->

**Response Number**: {data['response_number']}
**Timestamp**: {data['timestamp']}
**Status**: ✅ Success

{result}

---"""
    return output
```

**Pattern used by ALL agents**:
- Header with emoji number + agent name
- HTML comment with agent ID and phase
- Metadata fields (response number, timestamp, status)
- Raw DeepSeek result inserted
- Separator (`---`)

---

## ✨ Potential Improvements

### Issue 1: Duplicate Agent Description
**Current**: Agent description appears twice
```markdown
### Agent: Scene classification, character identification, pacing analysis  ← From AgentCoordinator
<!-- Agent ID: response_analyzer | Duration: 15234ms -->

### 1️⃣ Response Analyzer  ← From agent.format_output()
<!-- Agent ID: response_analyzer | Phase: 0.4 (Background Analysis) -->
```

**Fix**: Remove duplicate in `_format_context()`, let agent control its own header

### Issue 2: Inconsistent Metadata
**Current**: Some agents show different fields
- Background agents: `Response Number`, `Chapter`, `Timestamp`
- Immediate agents: `User Message`, `Timestamp`

**Fix**: Standardize metadata fields across all agents

### Issue 3: No Sections for Organization
**Current**: All 10 agents in one flat list

**Fix**: Group by type (matches AGENT_CACHE_SPEC.md):
```markdown
## 📊 BACKGROUND ANALYSIS (Response N)
[6 background agents]

## ⚡ IMMEDIATE CONTEXT (For Response N+1)
[4 immediate agents]
```

### Issue 4: Raw DeepSeek Output
**Current**: DeepSeek result inserted as-is, formatting varies

**Fix**: Parse DeepSeek output into structured sections or enforce consistent prompt

### Issue 5: No Condensed Injection Format
**Current**: Full cache (~3000+ tokens) would be injected into prompt

**Fix**: Create condensed version (~300-400 tokens) for prompt injection

---

## 🎯 Recommended Changes

### Priority 1: Fix Duplicate Headers
**Change**: `_format_context()` should NOT add `### Agent:` line
- Remove lines 256-257 from agent_coordinator.py
- Let each agent control its own header in `format_output()`

### Priority 2: Add Section Grouping
**Change**: Group agents by type in `save_to_cache()`
```python
# Separate background vs immediate agents
background_agents = [r for r in successful if r.agent_id in BACKGROUND_AGENT_IDS]
immediate_agents = [r for r in successful if r.agent_id in IMMEDIATE_AGENT_IDS]

# Add section headers
sections.append("## 📊 BACKGROUND ANALYSIS (Response N)")
[add background agents]

sections.append("## ⚡ IMMEDIATE CONTEXT (For Response N+1)")
[add immediate agents]
```

### Priority 3: Standardize Metadata
**Change**: All agents should have consistent metadata:
```python
**Response Number**: {response_number}
**Agent Type**: Background | Immediate
**Timestamp**: {timestamp}
**Status**: {status_emoji} {status_text}
**Duration**: {duration}ms
**Phase**: {phase}
```

### Priority 4: Create Condensed Injection Version
**New method**: `format_for_prompt()` in AgentCoordinator
- Extract key insights only (~30-50 tokens per agent)
- Total ~300-400 tokens for all agents
- Used for Claude prompt injection

---

## 📋 Implementation Checklist

- [ ] Remove duplicate agent headers in `_format_context()`
- [ ] Add section grouping (Background vs Immediate)
- [ ] Standardize metadata fields across all agents
- [ ] Create `format_for_prompt()` condensed version
- [ ] Add token reduction stats to performance summary
- [ ] Test cache file readability
- [ ] Verify prompt injection works with condensed format

---

**Summary**: Current implementation works but has formatting inconsistencies. Main issues are duplicate headers, no section grouping, and no condensed version for prompt injection. Priority fixes are straightforward and low-risk.
